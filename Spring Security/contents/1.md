# ê¸°ë³¸ API ë° Filter ì´í•´(1)

# í”„ë¡œì íŠ¸ êµ¬ì„± ë° ì˜ì¡´ì„± ì¶”ê°€

## dependency ì¶”ê°€

- Maven project: `pom.xml`

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

- Gradle project: `build.gradle`

```
implementation 'org.springframework.boot:spring-boot-starter-security'
```

## ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ ì˜ì¡´ì„± ì¶”ê°€ ì‹œ ì¼ì–´ë‚˜ëŠ” ì¼ë“¤

- ì„œë²„ê°€ ê°€ë™ë˜ë©´ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ ì´ˆê¸°í™” ì‘ì—… ë° ë³´ì•ˆ ì„¤ì •ì´ ì´ë£¨ì–´ì§„ë‹¤.
- ë³„ë„ì˜ ì„¤ì •ì´ë‚˜ êµ¬í˜„ì„ í•˜ì§€ ì•Šì•„ë„ ê¸°ë³¸ì ì¸ ì›¹ ë³´ì•ˆ ê¸°ëŠ¥ì´ í˜„ì¬ ì‹œìŠ¤í…œì— ì—°ë™ë˜ì–´ ì‘ë™í•¨
  - ëª¨ë“  ìš”ì²­ì€ ì¸ì¦ì´ ë˜ì–´ì•¼ ìì›ì— ì ‘ê·¼ì´ ê°€ëŠ¥í•¨.
  - ì¸ì¦ ë°©ì‹ì€ í¼ ë¡œê·¸ì¸ ë°©ì‹ê³¼ httpBasic ë¡œê·¸ì¸ ë°©ì‹ì„ ì œê³µí•¨
  - ê¸°ë³¸ ë¡œê·¸ì¸ í˜ì´ì§€ ì œê³µ
    ![](<https://images.velog.io/images/songs4805/post/7f78e018-f255-462a-9b0e-b094c32901ff/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-09%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%208.33.41(2).png>)
  - ê¸°ë³¸ ê³„ì • í•œ ê°œ ì œê³µ - username: user / password: ëœë¤ ë¬¸ìì—´
    ![](https://images.velog.io/images/songs4805/post/4f2408ca-0844-4390-958a-06054bb9f030/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-09%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%208.34.45.png)

> ğŸ“Œ ì°¸ê³ : ëœë¤ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë¬¸ìì—´ passwordì„ ê³ ì • ê°’ìœ¼ë¡œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
> `application.properties`ì— ë‹¤ìŒê³¼ ê°™ì´ ê¸°ë³¸ username/password ê°’ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

```
spring.security.user.name=user
spring.security.user.password=1234
```

## ë¬¸ì œì 

- ê³„ì • ì¶”ê°€, ê¶Œí•œ ì¶”ê°€, DB ì—°ë™ ë“±
- ê¸°ë³¸ì ì¸ ë³´ì•ˆ ê¸°ëŠ¥ ì™¸ì— ì‹œìŠ¤í…œì—ì„œ í•„ìš”ë¡œ í•˜ëŠ” ë” ì„¸ë¶€ì ì´ê³  ì¶”ê°€ì ì¸ ë³´ì•ˆ ê¸°ëŠ¥ì´ í•„ìš”í•˜ë‹¤.

# ì‚¬ìš©ì ì •ì˜ ë³´ì•ˆ ê¸°ëŠ¥ êµ¬í˜„

![](https://images.velog.io/images/songs4805/post/0ca53de5-99e4-43d3-a4f2-c41f40ab9a9e/IMG_7003613928A6-1.jpeg)

`WebSecurityConfigurerAdapter`: ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì˜ ì›¹ ë³´ì•ˆ ê¸°ëŠ¥ ì´ˆê¸°í™” ë° ì„¤ì •

- Security Dependencyë¥¼ ì¶”ê°€í•œ ì´í›„ ê¸°ë³¸ì ì¸ securityë¥¼ ì„¤ì • ë° êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤
- `HttpSecurity`ë¼ëŠ” ì„¸ë¶€ì ì¸ ë³´ì•ˆ ê¸°ëŠ¥ì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” APIë¥¼ ì œê³µí•œë‹¤.

## ì œê³µ API

| ì¸ì¦ API                   | ì¸ê°€ API(chain method)                           |
| -------------------------- | ------------------------------------------------ |
| `http.formLogin()`         | `http.authorizeRequests().anyMatchers(/admin)`   |
| `http.logout()`            | `http.authorizeRequests().hasRole(USER)`         |
| `http.csrf()`              | `http.authorizeRequests().permitAll()`           |
| `http.httpBasic()`         | `http.authorizeRequests().authenticated()`       |
| `http.SessionManagement()` | `http.authorizeRequests().fullyAuthentication()` |
| `http.RememberMe()`        | `http.authorizeRequests().access(hasRole(USER))` |
| `http.ExceptionHandling()` | `http.authorizeRequests().denyAll()`             |
| `http.addFilter()`         |                                                  |

ë‹¤ìŒê³¼ ê°™ì´ `SecurityConfig` ì„¤ì • í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ì¸ì¦/ì¸ê°€ APIë¥¼ ì¶”ê°€í•˜ì—¬ ë³´ì•ˆì„±ì„ ë†’ì¼ ìˆ˜ ìˆë‹¤.

```java
@Configuration
@EnableWebSecurity // ì›¹ ë³´ì•ˆ í™œì„±í™”ë¥¼ ìœ„í•œ annotation
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests() // ìš”ì²­ì— ì˜í•œ ë³´ì•ˆ ê²€ì‚¬ ì‹œì‘
                .anyRequest().authenticated() // ì–´ë–¤ ìš”ì²­ì—ë„ ë³´ì•ˆ ê²€ì‚¬ë¥¼ í•œë‹¤.
                .and()
                .formLogin(); // ë³´ì•ˆ ê²€ì¦ì€ formLogin ë°©ì‹ìœ¼ë¡œ í•˜ê² ë‹¤.
    }
}
```

- `@EnableWebSecurity` ì• ë…¸í…Œì´ì…˜ì„ `WebSecurityConfigurerAdapter`ë¥¼ ìƒì†í•˜ëŠ” ì„¤ì • ê°ì²´ì— ë¶™ì—¬ì£¼ë©´ SpringSecurityFilterChainì— ë“±ë¡ëœë‹¤.

> ğŸ“Œ ì°¸ê³ : `@EnableWebSecurity`
> ìŠ¤í”„ë§ MVCì—ì„œ ì›¹ ë³´ì•ˆì„ í™œì„±í™”í•˜ê¸° ìœ„í•œ ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ í•¸ë“¤ëŸ¬ ë©”ì†Œë“œì—ì„œ `@AuthenticationPrincipal` ì• ë…¸í…Œì´ì…˜ì´ ë¶™ì€ ë§¤ê°œë³€ìˆ˜ë¥¼ ì´ìš©í•´ ì¸ì¦ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•œë‹¤. ê·¸ë¦¬ê³  ìë™ìœ¼ë¡œ **CSRF í† í°**ì„ ìŠ¤í”„ë§ì˜ form binding tag libraryë¥¼ ì‚¬ìš©í•´ ì¶”ê°€í•˜ëŠ” ë¹ˆì„ ì„¤ì •í•œë‹¤.

# Form Login ì¸ì¦

![](https://images.velog.io/images/songs4805/post/c59a158a-8c21-40d7-95eb-b07095a7ccfc/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-09%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%2010.59.34.png)
ë¡œì§ í”Œë¡œìš°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

1. Clientì—ì„œ Get ë°©ì‹ìœ¼ë¡œ /home URL ìì› ì ‘ê·¼ ìš”ì²­
2. Serverì—ì„œëŠ” ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤ê³  íŒë‹¨í•˜ì—¬ ì¸ì¦ì´ ì•ˆë˜ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬
3. ClientëŠ” ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ username/passwordë¥¼ ì…ë ¥í•˜ì—¬ Post ë°©ì‹ìœ¼ë¡œ ì¸ì¦ ì‹œë„
4. Serverì—ì„œëŠ” Session ID ìƒì„± í›„ ì¸ì¦ ê²°ê³¼ë¥¼ ë‹´ì€ ì¸ì¦ í† í°(Authentication) ìƒì„± ë° ì €ì¥
5. Clientì—ì„œ /home ì ‘ê·¼ ìš”ì²­ ì‹œ ì„¸ì…˜ì— ì €ì¥ëœ ì¸ì¦ í† í°ìœ¼ë¡œ ì ‘ê·¼ ë° ì¸ì¦ ìœ ì§€

## Security Config ì„¤ì •

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .anyRequest().authenticated()
        .and()
                .formLogin()
                .loginPage("/loginPage") // ì‚¬ìš©ì ì •ì˜ ë¡œê·¸ì¸ í˜ì´ì§€
                .defaultSuccessUrl("/") // ë¡œê·¸ì¸ ì„±ê³µ í›„ ì´ë™ í˜ì´ì§€
                .failureUrl("/login") // ë¡œê·¸ì¸ ì‹¤íŒ¨ í›„ ì´ë™ í˜ì´ì§€
                .usernameParameter("userId") // ì•„ì´ë”” íŒŒë¼ë¯¸í„°ëª… ì„¤ì •
                .passwordParameter("passwd") // íŒ¨ìŠ¤ì›Œë“œ íŒŒë¼ë¯¸í„°ëª… ì„¤ì •
                .loginProcessingUrl("/login_proc") // ë¡œê·¸ì¸ Form Action Url
                .successHandler(new AuthenticationSuccessHandler() { // ë¡œê·¸ì¸ ì„±ê³µ í›„ í•¸ë“¤ëŸ¬
                    @Override
                    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
                        System.out.println("authentication = " + authentication.getName());
                        response.sendRedirect("/");
                    }
                })
                .failureHandler(new AuthenticationFailureHandler() { // ë¡œê·¸ì¸ ì‹¤íŒ¨ í›„ í•¸ë“¤ëŸ¬
                    @Override
                    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
                        System.out.println("exception = " + exception.getMessage());
                        response.sendRedirect("/login");
                    }
                })
                .permitAll(); // ì‚¬ìš©ì ì •ì˜ ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ê·¼ ê¶Œí•œ ìŠ¹ì¸
    }
}
```

# Form Login ì¸ì¦ í•„í„°

## UsernamePasswordAuthenticationFilter

ë¡œê·¸ì¸ ì¸ì¦ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•˜ê³  ì¸ì¦ì²˜ë¦¬ì— ê´€ë ¨ëœ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” í•„í„°ì´ë‹¤.

Login Form ì¸ì¦ ë¡œì§ í”Œë¡œìš°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

![](https://images.velog.io/images/songs4805/post/4afa2c11-f8be-40b8-b38f-3b9d79b047b7/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%201.19.35.png)

1. **AntPathRequestMatcher(/login)**
   â†’ ì‚¬ìš©ìê°€ ìš”ì²­í•œ ìš”ì²­ì •ë³´ë¥¼ í™•ì¸í•˜ì—¬ ìš”ì²­ì •ë³´ URLì´ `/login`ìœ¼ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
   â†’ ì¼ì¹˜í•œë‹¤ë©´ ë‹¤ìŒë‹¨ê³„ë¡œ(ì¸ì¦ì²˜ë¦¬) ì§„í–‰ë˜ê³ , ì¼ì¹˜í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë‹¤ìŒ í•„í„°(`chain.doFilter`)ë¡œ ì§„í–‰ëœë‹¤.
   // `/login` URLì€ `.loginProcessingUrl()`ë¡œ ë³€ê²½ ê°€ëŠ¥í•˜ë‹¤.
2. `Authentication`ì—ì„œ ì‹¤ì œ ì¸ì¦ì²˜ë¦¬ë¥¼ í•˜ê²Œ ë˜ëŠ”ë°, ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ì…ë ¥í•œ Usernameê³¼ Passwordë¥¼ ì¸ì¦ê°ì²´(`Authentication`)ì— ì €ì¥í•´ì„œ ì¸ì¦ì²˜ë¦¬(`AuthenticationManager`)ë¥¼ ë§¡ê¸°ëŠ” ì—­í• ì„ í•œë‹¤.
   â†’ **ì—¬ê¸°ê¹Œì§€ê°€ ì¸ì¦ì²˜ë¦¬ë¥¼ í•˜ê¸° ì „ í•„í„°ê°€ í•˜ëŠ” ì—­í• ì´ë‹¤.**
3. ì¸ì¦ê´€ë¦¬ì(`AuthenticationManager`)ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `AuthenticationProvider`ì—ê²Œ ì¸ì¦ì²˜ë¦¬ë¥¼ ìœ„ì„í•˜ê²Œ ëœë‹¤. í•´ë‹¹ Providerê°€ ì¸ì¦ì²˜ë¦¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ë¡œì¨ ì¸ì¦ ì„±ê³µ/ì‹¤íŒ¨ë¥¼ ë°˜í™˜í•˜ëŠ”ë° ì‹¤íŒ¨í•  ê²½ìš°, `AuthenticationException` ì˜ˆì™¸ë¥¼ ë°˜í™˜í•˜ì—¬ `UsernamePasswordAuthenticationFilter`ë¡œ ëŒì•„ê°€ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•˜ê³ , ì¸ì¦ì— ì„±ê³µí•  ê²½ìš° `Authentication` ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ User ê°ì²´ì™€ Authorities ê°ì²´ë¥¼ ë‹´ì•„ `AuthenticationManager`ì—ê²Œ ë°˜í™˜í•œë‹¤.
4. `AuthenticationManager`ëŠ” Providerë¡œë¶€í„° ë°˜í™˜ë°›ì€ ì¸ì¦ê°ì²´(ì¸ì¦ê²°ê³¼ ìœ ì €, ìœ ì € ê¶Œí•œì •ë³´)ë¥¼ `SecurityContext`ê°ì²´ì— ì €ì¥í•œë‹¤.
5. `SecurityContext`ëŠ” Sessionì—ë„ ì €ì¥ë˜ì–´ ì „ì—­ì ìœ¼ë¡œ `SecurityContext`ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë‹¤.
6. ì¸ì¦ ì„±ê³µ ì´í›„ì—ëŠ” `SuccessHandler`ì—ì„œ ì¸ì¦ ì„±ê³µ ì´í›„ì˜ ë¡œì§ì„ ìˆ˜í–‰í•˜ê²Œ ëœë‹¤.

### ì •ë¦¬

ì¸ì¦ì²˜ë¦¬ í•„í„°(`UsernamePasswordAuthenticationFilter`)ëŠ” Form ì¸ì¦ì²˜ë¦¬ë¥¼ í•˜ëŠ” í•„í„°ë¡œì¨ í•´ë‹¹ í•„í„°ëŠ” í¬ê²Œ ë‘ ê°€ì§€ë¡œ ì¸ì¦ ì „ê³¼ ì¸ì¦ í›„ì˜ ì‘ì—…ë“¤ì„ ê´€ë¦¬í•œë‹¤.

ì¸ì¦ì²˜ë¦¬ ì „ì—ëŠ” ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ ë‹´ì•„ì„œ ì „ë‹¬í•˜ë©´ì„œ ì¸ì¦ ì²˜ë¦¬ë¥¼ ë§¡ê¸°ê³ (`AuthenticationManager`) ì„±ê³µí•œ ì¸ì¦ê°ì²´ë¥¼ ë°˜í™˜ë°›ì•„ì„œ ì „ì—­ì ìœ¼ë¡œ ì¸ì¦ ê°ì²´ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ `SecurityContext`ì— ì €ì¥í•˜ê³ , ê·¸ ì´í›„ `SuccessHandler`ë¥¼ í†µí•´ ì¸ì¦ ì„±ê³µ í›„ì˜ í›„ì† ì‘ì—…ë“¤ì„ ì²˜ë¦¬í•œë‹¤.

![](https://images.velog.io/images/songs4805/post/c50d7f42-3906-4d1e-a2ec-dee966e3ff24/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%201.19.59.png)

// `AbstractAuthenticationProcessingFilter.java`ì˜ `doFilter()`, `attempAuthentication()`, `ProviderManager.java`ë¥¼ í™•ì¸í•´ë³´ì.

# Logout, LogoutFilter

![](https://images.velog.io/images/songs4805/post/a0099891-6f83-4a59-9a3b-1d4601c0cc69/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.48.16.png)

1. Clientì—ì„œ POST ë°©ì‹ì˜ `/logout` ë¦¬ì†ŒìŠ¤ í˜¸ì¶œ
2. Serverì—ì„œ **ì„¸ì…˜ ë¬´íš¨í™”, ì¸ì¦í† í° ì‚­ì œ, ì¿ í‚¤ì •ë³´ ì‚­ì œ** í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

## ì„¤ì • ì½”ë“œ

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .logout() // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                .logoutUrl("/logout") // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ URL
                .logoutSuccessUrl("/login") // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í›„ ì´ë™ í˜ì´ì§€
                .addLogoutHandler(new LogoutHandler() { // ë¡œê·¸ì•„ì›ƒ í•¸ë“¤ëŸ¬
                    @Override
                    public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) {
                        HttpSession session = request.getSession();
                        session.invalidate();
                    }
                })
                .logoutSuccessHandler(new LogoutSuccessHandler() { // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ í›„ í•¸ë“¤ëŸ¬
                    @Override
                    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
                        response.sendRedirect("/login");
                    }
                })
                .deleteCookies("remember-me"); // ë¡œê·¸ì•„ì›ƒ í›„ ì¿ í‚¤ ì‚­ì œ
    }
}
```

## Logic Flow

![](https://images.velog.io/images/songs4805/post/227b17d6-8b31-4bfa-8443-0abe482976e3/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%203.03.43.png)

1. ìš”ì²­ì´ Logout URLì¸ì§€ í™•ì¸
2. ë§ì„ ê²½ìš° `SecurityContext`ì—ì„œ ì¸ì¦ ê°ì²´(`Authentication`)ë¥¼ êº¼ë‚´ì˜¨ë‹¤.
3. `SecurityContextLogoutHandler`ì—ì„œ **ì„¸ì…˜ ë¬´íš¨í™”, ì¿ í‚¤ ì‚­ì œ, `clearContext()`** ë¥¼ í†µí•´ `SecurityContext` ê°ì²´ë¥¼ ì‚­ì œí•˜ê³  ì¸ì¦ ê°ì²´ë„ nullë¡œ ë§Œë“ ë‹¤.
4. `SimpleUrlLogoutSuccessHandler`ë¥¼ í†µí•´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚¨ë‹¤.

## Sequence Diagram

![](https://images.velog.io/images/songs4805/post/af981f84-be76-47f2-970c-8522ffc2255f/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%203.04.40.png)

# Remember Me ì¸ì¦

![](https://images.velog.io/images/songs4805/post/4f6e96b1-eab5-4264-9491-b50685541d1b/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.02.37.png)

- ì„¸ì…˜ì´ ë§Œë£Œë˜ê³  ì›¹ ë¸Œë¼ìš°ì €ê°€ ì¢…ë£Œëœ í›„ì—ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‚¬ìš©ìë¥¼ ê¸°ì–µí•˜ëŠ” ê¸°ëŠ¥
- Remember-Me ì¿ í‚¤ì— ëŒ€í•œ HTTP ìš”ì²­ì„ í™•ì¸í•œ í›„ í† í° ê¸°ë°˜ ì¸ì¦ì„ ì‚¬ìš©í•´ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ê³  í† í°ì´ ê²€ì¦ë˜ë©´ ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ ëœë‹¤.
- ì‚¬ìš©ì ë¼ì´í”„ ì‚¬ì´í´
  - ì¸ì¦ ì„±ê³µ(Remember-Me ì¿ í‚¤ ì„¤ì •)
  - ì¸ì¦ ì‹¤íŒ¨(ì¿ í‚¤ê°€ ì¡´ì¬í•˜ë©´ ì¿ í‚¤ ë¬´íš¨í™”)
  - ë¡œê·¸ì•„ì›ƒ(ì¿ í‚¤ê°€ ì¡´ì¬í•˜ë©´ ì¿ í‚¤ ë¬´íš¨í™”)
- SessionID ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ë”ë¼ë„ Remember-Meê°€ ìˆë‹¤ë©´ í•´ë‹¹ ì¿ í‚¤ë¥¼ decodingí•œ ë‹¤ìŒ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. (EditThisCookie í™•ì¥ í”„ë¡œê·¸ë¨ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í•´ë³´ë©´ ì•Œ ìˆ˜ ìˆë‹¤.)

## ì„¤ì • ì½”ë“œ

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    UserDetailsService userDetailsService;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .rememberMe() // Remember-Me ê¸°ëŠ¥ ì‘ë™
                .rememberMeParameter("remember") // ê¸°ë³¸ íŒŒë¼ë¯¸í„°ëª…ì€ remember-me
                .tokenValiditySeconds(3600) // DefaultëŠ” 14ì¼
                .alwaysRemember(true) // ë¦¬ë©¤ë²„ ë¯¸ ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì§€ ì•Šì•„ë„ í•­ìƒ ì‹¤í–‰
                .userDetailsService(userDetailsService);
    }
}
```

# Remember Me ì¸ì¦ í•„í„°

## RememberMeAuthenticationFilter

![](https://images.velog.io/images/songs4805/post/3f594ae3-dae2-46af-bec4-f2e89d582cb4/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.18.05.png)

1. Clientì—ì„œ ìš”ì²­(ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê³ , ì‚¬ìš©ìëŠ” Form ì¸ì¦ ë°›ì„ ë‹¹ì‹œ Remember Meë¥¼ ì‚¬ìš©í•˜ì˜€ê¸°ì— RememberMe Cookieë¥¼ ê°€ì§€ê³  ìˆìŒ)
2. `RememberMeAuthenticationFilter`ê°€ ë™ì‘
3. `RememberMeService` ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ ë™ì‘  
   â†’ `TokenBasedRememberMeService` : ë©”ëª¨ë¦¬ì—ì„œ ì €ì¥í•œ í† í°ê³¼ ì‚¬ìš©ìê°€ ê°€ì ¸ì˜¨ í† í°ì„ ë¹„êµ(defaultëŠ” 14ì¼ ë³´ì¡´)í•˜ëŠ” êµ¬í˜„ì²´
   â†’ `PersistentTokenBasedRememberMeService`: DBì— ë°œê¸‰í•œ í† í°ê³¼ ì‚¬ìš©ìê°€ ê°€ì ¸ì˜¨ í† í°ì„ ë¹„êµí•´ì„œ ì¸ì¦ ì²˜ë¦¬í•˜ëŠ” êµ¬í˜„ì²´
4. Token Cookie ì¶”ì¶œ
5. Tokenì´ ì¡´ì¬í•˜ëŠ”ì§€ ê²€ì‚¬ â†’ ë§Œì•½ ì—†ë‹¤ë©´ ë‹¤ìŒ í•„í„° ë™ì‘
6. Decode Tokenìœ¼ë¡œ Tokenì˜ formatì´ ê·œì¹™ì— ë§ëŠ”ì§€ ìœ íš¨ì„± ê²€ì‚¬  
   â†’ ìœ íš¨ì„±ì´ invalidate í•˜ë‹¤ë©´ Exception ë°œìƒ
7. í† í°ì´ ì„œë¡œ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬  
   â†’ í† í°ì´ ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš° Exception ë°œìƒ
8. í† í°ì— User ê³„ì •ì´ ì¡´ì¬í•˜ëŠ”ì§€ ê²€ì‚¬  
   â†’ ì—†ìœ¼ë©´ Exception ë°œìƒ
9. ìƒˆë¡œìš´ Authentication Objectë¥¼ ìƒì„±í•˜ì—¬ ì¸ì¦ì²˜ë¦¬
10. `AuthenticationManager` ì¸ì¦ ê´€ë¦¬ìì—ê²Œ ì „ë‹¬í•˜ì—¬ ì¸ì¦ì²˜ë¦¬ ìˆ˜í–‰

## Sequence Diagram

![](https://images.velog.io/images/songs4805/post/205ebae0-8331-42fe-a899-bc9f72646e34/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.37.23.png)

# ìµëª… ì‚¬ìš©ì ì¸ì¦ í•„í„°

## AnonymousAuthenticationFilter

![](https://images.velog.io/images/songs4805/post/38d5ba38-e038-420d-80a2-556e0b92776a/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.44.38.png)

- ì¸ì¦ê°ì²´ê°€ ì—†ëŠ” ìµëª…ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬ í•„í„°
- ìµëª…ì‚¬ìš©ìì™€ ì¸ì¦ ì‚¬ìš©ìë¥¼ êµ¬ë¶„í•´ì„œ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ìš©ë„ë¡œ ì‚¬ìš©: íŠ¹ì • ìì›(í˜ì´ì§€)ì— ì ‘ê·¼ì‹œë„ì‹œ ì¸ì¦ ê°ì²´ë¥¼ ê²€ì‚¬í•˜ëŠ”ë° ë§Œì•½ sessionì„ ë°œê¸‰ë°›ì€ ì¸ì¦ê°ì²´ê°€ ìˆëŠ” ì‚¬ìš©ìì¼ ê²½ìš° í•´ë‹¹ ê°ì²´ë¥¼ ê°€ì§€ê³  ë‹¤ìŒ í•„í„°ë¥¼ ë™ì‘í•˜ì§€ë§Œ, ì¸ì¦ ê°ì²´ê°€ ì—†ì„ ê²½ìš° ìµëª…ì‚¬ìš©ììš© ì¸ì¦ ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ê³  ìˆë‹¤.
- í™”ë©´ì—ì„œ ì¸ì¦ ì—¬ë¶€ë¥¼ êµ¬í˜„í•  ë•Œ `isAnonymous()`ì™€ `isAuthenticated()`ë¡œ êµ¬ë¶„í•´ì„œ ì‚¬ìš©
- ì¸ì¦ ê°ì²´ë¥¼ ì„¸ì…˜ì— ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

# ë™ì‹œ ì„¸ì…˜ ì œì–´, ì„¸ì…˜ ê³ ì • ë³´í˜¸, ì„¸ì…˜ ì •ì±…

A ì»´í“¨í„°ì—ì„œ ë¡œê·¸ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë‹¤ê°€ íƒœë¸”ë¦¿PC í˜¹ì€ ë‹¤ë¥¸ ì»´í“¨í„° ë“±ì—ì„œ ê°™ì€ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ê¸° ìœ„í•´ ë¡œê·¸ì¸ì„ ì‹œë„í•  ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ ì´ëŸ° ë‹¤ì¤‘ ì ‘ì†ì‹œë„ê°€ ë¬´í•œì • í—ˆìš©ë  ê²½ìš°, ì—¬ëŸ¬ ë¬¸ì œì ì„ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤. ë‹¤ì¤‘ ë¡œê·¸ì¸ì„ í—ˆìš©í•´ ë™ì‹œ ì ‘ì†ì´ ëœë‹¤ë©´, í•œ ëª…ì´ ì„œë¹„ìŠ¤ ê²°ì œë¥¼ í•œ ë’¤ ëª¨ë‘ê°€ ê³µìœ í•´ì„œ ë³´ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²ƒì´ ê·¸ ì˜ˆì‹œì´ë‹¤.

Netflixê°™ì€ OTT ì„œë¹„ìŠ¤ì—ì„  ë‹¤ì¤‘ ì ‘ì†ì˜ ê²½ìš° ì¸ì› ì œí•œì„ ë‘ê³  ê³¼ê¸ˆ ëª¨ë¸ì„ ë§Œë“¤ì–´ ì œí•œì ì¸ ë™ì‹œ ì„¸ì…˜ì„ í—ˆìš©í•´ì£¼ê³  ìˆë‹¤. Spring Securityì—ì„œëŠ” ì´ëŸ° ì„¸ì…˜ì— ëŒ€í•œ ê´€ë¦¬ ê¸°ëŠ¥ë„ ë‹¤ìŒê³¼ ê°™ì´ ì œê³µí•œë‹¤.

- ì„¸ì…˜ ê´€ë¦¬: ì¸ì¦ ì‹œ ì‚¬ìš©ìì˜ ì„¸ì…˜ ì •ë³´ë¥¼ **ë“±ë¡, ì¡°íšŒ, ì‚­ì œ** ë“±ì˜ ì„¸ì…˜ ì´ë ¥ì„ ê´€ë¦¬
- ë™ì‹œì  ì„¸ì…˜ ì œì–´: ë™ì¼ ê³„ì •ìœ¼ë¡œ ì ‘ì†ì´ í—ˆìš©ë˜ëŠ” ìµœëŒ€ ì„¸ì…˜ ìˆ˜ë¥¼ ì œí•œ
- ì„¸ì…˜ ê³ ì • ë³´í˜¸: ì¸ì¦í•  ë•Œë§ˆë‹¤ ì„¸ì…˜ ì¿ í‚¤ë¥¼ ìƒˆë¡œ ë°œê¸‰í•˜ì—¬ ê³µê²©ìì˜ ì¿ í‚¤ ì¡°ì‘ì„ ë°©ì§€
- ì„¸ì…˜ ìƒì„± ì •ì±…: `ALWAYS`, `IF_REQUIRED`, `NEVER`, `STATELESS`

## ë™ì‹œ ì„¸ì…˜ ì œì–´

![](https://images.velog.io/images/songs4805/post/e50eb315-ea41-4926-9758-55697cc68ca3/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%207.06.03.png)

ë™ì‹œ ì„¸ì…˜ ì œì–´ë€ ê°™ì€ ê³„ì •(ì„¸ì…˜)ì„ ë™ì‹œì— ëª‡ ê°œê¹Œì§€ ìœ ì§€í•  ìˆ˜ ìˆê²Œ í•  ì§€ì— ëŒ€í•œ ì œì–´ë¥¼ ì˜ë¯¸í•œë‹¤.
ê¸°ì¡´ ì ‘ì†í•´ìˆëŠ” ê³„ì •ì´ ìˆë‹¤ê³  í•  ë•Œ, ìƒˆë¡œìš´ ì‚¬ìš©ìê°€ ë™ì¼í•œ ê³„ì •ìœ¼ë¡œ ì ‘ì†ì„ ì‹œë„í–ˆì„ ë•Œ ì–´ë–»ê²Œ ëŒ€ì‘í• ì§€ì— ëŒ€í•œ ë°©ë²•ìœ¼ë¡œ ê¸°ì¡´ ì‚¬ìš©ìë¥¼ ë¡œê·¸ì•„ì›ƒ ì‹œí‚¤ê±°ë‚˜ í˜„ì¬ ì‚¬ìš©ìê°€ ì ‘ì†ì„ í•  ìˆ˜ ì—†ê²Œ ë§‰ëŠ” ì‹ì´ë‹¤.

**ìµœëŒ€ ì„¸ì…˜ í—ˆìš© ê°œìˆ˜ë¥¼ ì´ˆê³¼í•˜ì˜€ì„ ê²½ìš°ì˜ ì²˜ë¦¬ ë¡œì§ ì „ëµ 2ê°€ì§€**

- ì´ì „ ì‚¬ìš©ì ì„¸ì…˜ ë§Œë£Œ ì „ëµ: ì‹ ê·œ ë¡œê·¸ì¸ ì‹œ ê¸°ì¡´ ë¡œê·¸ì¸ ê³„ì •ì˜ ì„¸ì…˜ì´ ë§Œë£Œë˜ë„ë¡ ì„¤ì •í•˜ì—¬ ê¸°ì¡´ ì‚¬ìš©ìê°€ ìì› ì ‘ê·¼ì‹œ ì„¸ì…˜ ë§Œë£Œê°€ ëœë‹¤.
- í˜„ì¬ ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨ ì „ëµ: ì‹ ê·œ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ ì‹œë„ì‹œ ì¸ì¦ ì˜ˆì™¸ ë°œìƒ

### ë™ì‹œ ì„¸ì…˜ ì œì–´ ì„¤ì •

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    UserDetailsService userDetailsService;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .sessionManagement() // ì„¸ì…˜ ê´€ë¦¬ ê¸°ëŠ¥ì´ ì‘ë™í•¨
                .maximumSessions(1) // ìµœëŒ€ í—ˆìš© ê°€ëŠ¥ ì„¸ì…˜ ìˆ˜, -1: ë¬´ì œí•œ ë¡œê·¸ì¸ ì„¸ì…˜ í—ˆìš©
                .maxSessionsPreventsLogin(true) // ë™ì‹œ ë¡œê·¸ì¸ ì°¨ë‹¨í•¨, false: ê¸°ì¡´ ì„¸ì…˜ ë§Œë£Œ(default)
                .invalidSessionUrl("/invalid") // ì„¸ì…˜ì´ ìœ íš¨í•˜ì§€ ì•Šì„ ë•Œ ì´ë™í•  í˜ì´ì§€
                .expiredUrl("/expired"); // ì„¸ì…˜ì´ ë§Œë£Œëœ ê²½ìš° ì´ë™í•  í˜ì´ì§€
    }
}
```

## ì„¸ì…˜ ê³ ì • ë³´í˜¸

ì‚¬ìš©ìê°€ ê³µê²©ì ì„¸ì…˜ ì¿ í‚¤ë¡œ ë¡œê·¸ì¸ì„ ì‹œë„í•˜ë”ë¼ë„ ë¡œê·¸ì¸ì‹œë§ˆë‹¤ ìƒˆë¡œìš´ ì„¸ì…˜IDë¥¼ ë°œê¸‰í•˜ì—¬ ì œê³µí•˜ê²Œ ë˜ë©´, `JSESSIONID`ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì—, ê³µê²©ìëŠ” ê°™ì€ ì¿ í‚¤ê°’ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê³µìœ ë°›ì„ ìˆ˜ ì—†ê²Œ ëœë‹¤.

![](https://images.velog.io/images/songs4805/post/e06e12c1-c8ff-4854-8007-dc8653fab865/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202022-02-13%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%209.30.16.png)

> ğŸ“Œ **ì„¸ì…˜ ê³ ì • ê³µê²©?**
> ê³µê²©ìê°€ ì„œë²„ì— ì ‘ì†í•´ì„œ `JSESSIONID`ë¥¼ ë°œê¸‰ë°›ì•„ ì‚¬ìš©ìì—ê²Œ ìì‹ ì´ ë°œê¸‰ë°›ì€ ì„¸ì…˜ ì¿ í‚¤ë¥¼ ì‹¬ì–´ë†“ê²Œ ë˜ë©´ ì‚¬ìš©ìê°€ ì„¸ì…˜ ì¿ í‚¤ë¡œ ë¡œê·¸ì¸ì„ ì‹œë„í–ˆì„ ê²½ìš° ê³µê²©ìëŠ” ê°™ì€ ì¿ í‚¤ê°’ìœ¼ë¡œ ì¸ì¦ë˜ì–´ ìˆê¸°ë•Œë¬¸ì— ê³µê²©ìëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ê³µìœ í•˜ê²Œ ëœë‹¤.

### ì„¸ì…˜ ê³ ì • ë³´í˜¸ ì„¤ì •

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    UserDetailsService userDetailsService;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .sessionManagement()
                .sessionFixation().changeSessionId(); // ê¸°ë³¸ê°’: ì„¸ì…˜ì€ ìœ ì§€í•˜ë˜ ì„¸ì…˜ ì•„ì´ë””ëŠ” ê³„ì† ìƒˆë¡œ ë°œê¸‰
                // (Servlet 3.1 ì´ìƒ ê¸°ë³¸ê°’)
                // none, migrateSession, newSession
    }
}
```

- `none()`: ì„¸ì…˜ì´ ìƒˆë¡œ ìƒì„±ë˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€ë˜ê¸° ë•Œë¬¸ì— ì„¸ì…˜ ê³ ì • ê³µê²©ì— ì·¨ì•½í•˜ë‹¤.
- `migrateSession()`: ìƒˆë¡œìš´ ì„¸ì…˜ë„ ìƒì„±ë˜ê³  ì„¸ì…˜ì•„ì´ë””ë„ ë°œê¸‰ëœë‹¤. ì¶”ê°€ë¡œ ì´ì „ ì„¸ì…˜ì˜ ì†ì„±ê°’ë“¤ë„ ìœ ì§€ëœë‹¤.
- `newSession()`: ì„¸ì…˜ì´ ìƒˆë¡­ê²Œ ìƒì„±ë˜ê³ , ì„¸ì…˜ì•„ì´ë””ë„ ë°œê¸‰ë˜ì§€ë§Œ, ì´ì „ ì„¸ì…˜ì˜ ì†ì„±ê°’ë“¤ì„ ìœ ì§€í•  ìˆ˜ ì—†ë‹¤.

## ì„¸ì…˜ ì •ì±…

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    UserDetailsService userDetailsService;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.If_Required);
    }
}
```

- `SessionCreationPolicy.Always`: ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ í•­ìƒ ì„¸ì…˜ ìƒì„±
- `SessionCreationPolicy.If_Required`: ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ í•„ìš” ì‹œ ìƒì„±(ê¸°ë³¸ê°’)
- `SessionCreationPolicy.Never`: ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ìƒì„±í•˜ì§€ ì•Šì§€ë§Œ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì‚¬ìš©
- `SessionCreationPolicy.Stateless`: ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ê°€ ìƒì„±í•˜ì§€ ì•Šê³  ì¡´ì¬í•´ë„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ  
  â†’ JWT í† í°ë°©ì‹ì„ ì‚¬ìš©í•  ë•ŒëŠ” Stateless ì •ì±…ì„ ì‚¬ìš©í•œë‹¤.
